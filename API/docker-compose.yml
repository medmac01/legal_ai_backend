# Description: 
#     Docker Compose configuration for the PAKTON API service stack.
#     Orchestrates RabbitMQ message broker, Redis result backend, FastAPI service,
#     and Celery worker for distributed task processing.
#     
# Author: Raptopoulos Petros [petrosrapto@gmail.com]
# Date  : 2025/03/10

version: "3.8"

services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: always

  # Redis for Celery result backend (internal only, no host port mapping to avoid conflict)
  redis:
    image: redis:latest
    container_name: api_redis
    # No port mapping - only accessible within Docker network
    restart: always

  multiagentframework_service:
    container_name: multiagentframework_service
    build:
      context: ..
      dockerfile: API/Dockerfile
      network: host
    depends_on:
      - rabbitmq
      - redis
      - postgres
    env_file:
      - .env
    environment:
      CELERY_BROKER_URL: "amqp://rabbitmq:5672"
      CELERY_RESULT_BACKEND: "redis://redis:6379/0"
      SERVICE_NAME: "multiagentframework_service"
      PYTHONUNBUFFERED: "1"
    ports:
      - "5001:5001"
    restart: always
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
      - chroma_data:/chroma_db

  multiagentframework_worker:
    container_name: multiagentframework_worker
    build:
      context: ..
      dockerfile: API/Dockerfile
      network: host
    depends_on:
      - multiagentframework_service
      - rabbitmq
      - redis
      - postgres
    working_dir: /app
    command: [
      "celery",
      "-A", "API.tasks.celery_app",
      "worker",
      "-Q", "multiagentframework_service_queue",
      "--concurrency=1",
      "--loglevel=debug"
    ]
    env_file:
      - .env
    environment:
      CELERY_BROKER_URL: "amqp://rabbitmq:5672"
      CELERY_RESULT_BACKEND: "redis://redis:6379/0"
      SERVICE_NAME: "multiagentframework_service"
      PYTHONUNBUFFERED: "1"
    restart: always
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
      - chroma_data:/chroma_db

  # PostgreSQL service for persistence of the conversations of the Archivist
  postgres:
    image: postgres:15-alpine
    container_name: archivist_postgres
    env_file:
      - .env
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

volumes:
  postgres_data:
  chroma_data: